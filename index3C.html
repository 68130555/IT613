<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Accident Intelligence Map — Hotspot & Severity</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.heat (Heatmap) -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <!-- MarkerCluster (optional overlay) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend, .filters {
      background: #fff; padding: 10px 12px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      font: 14px/1.3 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .legend { position: absolute; bottom: 14px; left: 12px; }
    .filters { position: absolute; top: 12px; left: 12px; }
    .filters label { margin-right: 10px; }
    .brand {
      position: absolute; top: 12px; right: 12px; background: #fff; padding: 8px 10px; border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15); font: 13px/1.2 system-ui;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ฟิลเตอร์ความรุนแรง -->
  <div class="filters">
    <b>แสดงระดับความรุนแรง:</b><br/>
    <label><input type="checkbox" class="sev-filter" value="High" checked> High</label>
    <label><input type="checkbox" class="sev-filter" value="Medium" checked> Medium</label>
    <label><input type="checkbox" class="sev-filter" value="Low" checked> Low</label>
  </div>

  <!-- Legend -->
  <div class="legend">
    <b>คำอธิบายสี:</b><br/>
    <span style="color:#d73027;">●</span> High &nbsp;
    <span style="color:#fc8d59;">●</span> Medium &nbsp;
    <span style="color:#1a9850;">●</span> Low<br/>
    <small>Heatmap เข้ม = จุดเสี่ยง/ความหนาแน่นสูง</small>
  </div>

  <div class="brand">
    Accident Intelligence Map<br/>
    <small>Hotspot (Heat) + Severity (XGBoost)</small>
  </div>

  <script>
    // --------------------------
    // 1) สร้างแผนที่ + basemaps
    // --------------------------
    const map = L.map('map', {center: [15.5, 101.0], zoom: 6});

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19, attribution: '© OpenStreetMap'
    }).addTo(map);

    const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
      maxZoom: 19, attribution: '© CARTO, © OpenStreetMap'
    });

    const baseMaps = {
      "OSM Light": osm,
      "Carto Dark": cartoDark
    };

    // --------------------------
    // 2) เตรียม overlays ว่างๆ รอเติม
    // --------------------------
    const heatLayer = L.heatLayer([], { 
      radius: 20, blur: 16, maxZoom: 12, max: 1.0 
    });

    const severityLayer = L.layerGroup();           // วงกลมสีตาม severity
    const severityCluster = L.markerClusterGroup(); // ตัวเลือก: cluster markers

    const overlays = {
      "Hotspot Heatmap": heatLayer,
      "Severity Markers": severityLayer,
      "Clustered Markers": severityCluster
    };

    // Layer control
    L.control.layers(baseMaps, overlays, { collapsed: false }).addTo(map);

    // --------------------------
    // 3) ยูทิลิตี้ / สไตล์
    // --------------------------
    function colorBySeverity(sev){
      if (sev === "High")   return "#d73027"; // แดง
      if (sev === "Medium") return "#fc8d59"; // ส้ม
      return "#1a9850";                      // เขียว
    }
    function radiusByRisk(risk){ 
      // ปรับขนาดวงกลมตาม risk_score (0-100) → 6..14
      const r = Math.max(6, Math.min(14, (risk||0)/10 + 6));
      return r;
    }
    // เก็บข้อมูลดิบไว้ให้ฟิลเตอร์
    let rawData = [];
    let activeSeverities = new Set(["High","Medium","Low"]);

    // --------------------------
    // 4) โหลดข้อมูล & วาดชั้นข้อมูล
    // --------------------------
    fetch('accident_preds.json')
      .then(r => r.json())
      .then(data => {
        rawData = data;

        // 4.1 สร้าง Heatmap points: [lat, lng, intensity]
        // intensity ใช้ risk_score (0..100) → scale เป็น 0..1
        const heatPoints = data
          .filter(d => isFinite(d.lat) && isFinite(d.lng))
          .map(d => [d.lat, d.lng, Math.max(0, Math.min(1, (d.risk_score || 0) / 100))]);

        heatLayer.setLatLngs(heatPoints).addTo(map);

        // 4.2 วาด severity markers ครั้งแรก
        renderSeverityLayers();
      })
      .catch(err => {
        console.error("Error loading accident_preds.json:", err);
        alert("ไม่พบไฟล์ accident_preds.json หรือรูปแบบข้อมูลไม่ถูกต้อง");
      });

    // --------------------------
    // 5) ฟังก์ชันวาด/อัปเดตชั้น Severity
    // --------------------------
    function renderSeverityLayers(){
      severityLayer.clearLayers();
      severityCluster.clearLayers();

      const filtered = rawData.filter(d =>
        isFinite(d.lat) && isFinite(d.lng) && activeSeverities.has(d.severity));

      filtered.forEach(pt => {
        const color = colorBySeverity(pt.severity);
        const circle = L.circleMarker([pt.lat, pt.lng], {
          radius: radiusByRisk(pt.risk_score),
          color: "#333",
          weight: 1,
          fillColor: color,
          fillOpacity: 0.75
        }).bindPopup(`
          <b>Severity:</b> <span style="color:${color}">${pt.severity}</span><br/>
          <b>Risk Score:</b> ${pt.risk_score ?? "-"}<br/>
          <b>Cluster:</b> ${pt.cluster ?? "-"}<br/>
          ${pt.province ? `<b>จังหวัด:</b> ${pt.province}<br/>` : ""}
          ${pt.date ? `<b>วันที่:</b> ${pt.date}<br/>` : ""}
        `);

        severityLayer.addLayer(circle);

        // Clustered marker (ใช้ Marker แทน CircleMarker เพื่อรวมคลัสเตอร์)
        const marker = L.circleMarker([pt.lat, pt.lng], {
          radius: 6, color: color, fillColor: color, fillOpacity: 0.8, weight: 1
        }).bindPopup(`
          <b>Severity:</b> <span style="color:${color}">${pt.severity}</span><br/>
          <b>Risk Score:</b> ${pt.risk_score ?? "-"}<br/>
          <b>Cluster:</b> ${pt.cluster ?? "-"}<br/>
          ${pt.province ? `<b>จังหวัด:</b> ${pt.province}<br/>` : ""}
          ${pt.date ? `<b>วันที่:</b> ${pt.date}<br/>` : ""}
        `);
        severityCluster.addLayer(marker);
      });

      // เปิดสอง overlay เป็นค่าเริ่มต้น
      if (!map.hasLayer(severityLayer)) severityLayer.addTo(map);
      if (!map.hasLayer(heatLayer)) heatLayer.addTo(map);
    }

    // --------------------------
    // 6) ฟิลเตอร์ความรุนแรง (checkbox)
    // --------------------------
    document.querySelectorAll('.sev-filter').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const val = e.target.value;
        if (e.target.checked) activeSeverities.add(val);
        else activeSeverities.delete(val);
        renderSeverityLayers();
      });
    });

    // เคล็ดลับ: ถ้าอยาก "เปรียบเทียบ" แผนที่แบบสไลด์ซ้าย-ขวา
    // สามารถใส่ปลั๊กอิน leaflet-side-by-side แล้วใช้ base-tiles สองอันเทียบกัน
    // https://github.com/digidem/leaflet-side-by-side
  </script>
</body>
</html>
